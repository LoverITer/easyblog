(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],a)}else{a(CodeMirror)}}})(function(e){function a(s,r){if(typeof s=="string"){s=new RegExp(s.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),r?"gi":"g")}else{if(!s.global){s=new RegExp(s.source,s.ignoreCase?"gi":"g")}}return{token:function(u){s.lastIndex=u.pos;var t=s.exec(u.string);if(t&&t.index==u.pos){u.pos+=t[0].length;return"searching"}else{if(t){u.pos=t.index}else{u.skipToEnd()}}}}}function m(){this.posFrom=this.posTo=this.query=null;this.overlay=null}function h(r){return r.state.search||(r.state.search=new m())}function q(r){return typeof r=="string"&&r==r.toLowerCase()}function o(r,s,t){return r.getSearchCursor(s,t,q(s))}function l(r,u,s,v,t){if(r.openDialog){r.openDialog(u,t,{value:v})}else{t(prompt(s,v))}}function p(s,u,t,r){if(s.openConfirm){s.openConfirm(u,r)}else{if(confirm(t)){r[0]()}}}function d(s){var r=s.match(/^\/(.*)\/([a-z]*)$/);if(r){try{s=new RegExp(r[1],r[2].indexOf("i")==-1?"":"i")}catch(t){}}if(typeof s=="string"?s=="":s.test("")){s=/x^/}return s}var c='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function k(r,s){var t=h(r);if(t.query){return i(r,s)}l(r,c,"Search for:",r.getSelection(),function(u){r.operation(function(){if(!u||t.query){return}t.query=d(u);r.removeOverlay(t.overlay,q(t.query));t.overlay=a(t.query,q(t.query));r.addOverlay(t.overlay);if(r.showMatchesOnScrollbar){if(t.annotate){t.annotate.clear();t.annotate=null}t.annotate=r.showMatchesOnScrollbar(t.query,q(t.query))}t.posFrom=t.posTo=r.getCursor();i(r,s)})})}function i(r,s){r.operation(function(){var t=h(r);var u=o(r,t.query,s?t.posFrom:t.posTo);if(!u.find(s)){u=o(r,t.query,s?e.Pos(r.lastLine()):e.Pos(r.firstLine(),0));if(!u.find(s)){return}}r.setSelection(u.from(),u.to());r.scrollIntoView({from:u.from(),to:u.to()});t.posFrom=u.from();t.posTo=u.to()})}function n(r){r.operation(function(){var s=h(r);if(!s.query){return}s.query=null;r.removeOverlay(s.overlay);if(s.annotate){s.annotate.clear();s.annotate=null}})}var g='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';var j='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>';var f="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";function b(r,s){if(r.getOption("readOnly")){return}l(r,g,"Replace:",r.getSelection(),function(t){if(!t){return}t=d(t);l(r,j,"Replace with:","",function(x){if(s){r.operation(function(){for(var z=o(r,t);z.findNext();){if(typeof t!="string"){var y=r.getRange(z.from(),z.to()).match(t);z.replace(x.replace(/\$(\d)/g,function(A,B){return y[B]}))}else{z.replace(x)}}})}else{n(r);var w=o(r,t,r.getCursor());var v=function(){var z=w.from(),y;if(!(y=w.findNext())){w=o(r,t);if(!(y=w.findNext())||(z&&w.from().line==z.line&&w.from().ch==z.ch)){return}}r.setSelection(w.from(),w.to());r.scrollIntoView({from:w.from(),to:w.to()});p(r,f,"Replace?",[function(){u(y)},v])};var u=function(y){w.replace(typeof t=="string"?x:x.replace(/\$(\d)/g,function(z,A){return y[A]}));v()};v()}})})}e.commands.find=function(r){n(r);k(r)};e.commands.findNext=k;e.commands.findPrev=function(r){k(r,true)};e.commands.clearSearch=n;e.commands.replace=b;e.commands.replaceAll=function(r){b(r,true)}});